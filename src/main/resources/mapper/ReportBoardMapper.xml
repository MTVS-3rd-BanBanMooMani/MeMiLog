<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.banbanmoomani.memilog.DAO.ReportBoardMapper">

    <resultMap id="unProcessedPostListResultMap" type="com.banbanmoomani.memilog.DTO.admin.report.unProcessedPostListDTO">
        <id property="post_id" column="post_id"/>
        <result property="reported_user_nickName" column="reported_user_nickName"/>
        <result property="post_content" column="post_content"/>
        <result property="report_content" column="report_content"/>
        <result property="report_count" column="report_count"/>
        <result property="rpt_category" column="rpt_category"/>
        <result property="report_datetime" column="report_datetime" javaType="java.util.Date" jdbcType="TIMESTAMP"/>
    </resultMap>

    <select id="getUnProcessedPostList" resultMap="unProcessedPostListResultMap">
        SELECT
            a.post_id,
            b.nickName AS reported_user_nickName,
            p.content AS post_content,
            a.content AS report_content,
            (SELECT COUNT(*) FROM REPORT WHERE post_id = a.post_id) AS report_count,
            d.category_name AS rpt_category,
            a.report_datetime
        FROM REPORT a
        LEFT JOIN USER b ON a.reported_user_id = b.user_id
        LEFT JOIN POST p ON a.post_id = p.post_id
        LEFT JOIN RPT_CATEGORY d ON a.rpt_category_id = d.rpt_category_id
        WHERE a.report_datetime = (
        SELECT MAX(report_datetime)
        FROM REPORT
        WHERE post_id = a.post_id
        )
    </select>
</mapper>
