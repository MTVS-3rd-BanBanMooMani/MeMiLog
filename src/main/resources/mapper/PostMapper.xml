<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.banbanmoomani.memilog.DAO.PostMapper">

    <resultMap id="postResultMap" type="com.banbanmoomani.memilog.DTO.post.PostDTO">
        <id property="postId" column="post_id"/>
        <result property="content" column="content"/>
        <result property="likeCount" column="like_count"/>
        <result property="missionContent" column="mission_content"/>
        <result property="writtenDatetime" column="written_datetime"/>
        <result property="userId" column="user_id"/>
        <result property="missionDate" column="mission_date"/>
        <result property="priThemeName" column="pri_theme_name"/>
        <result property="subThemeName" column="sub_theme_name"/>
        <result property="emotionName" column="emotion_name"/>
        <result property="companionType" column="companion_type"/>
        <result property="reportCount" column="report_count"/>
        <result property="hiddenYN" column="hidden_YN"/>
    </resultMap>

    <select id="findAllPost" resultMap="postResultMap">
        SELECT
            p.post_id,
            p.content,
            p.like_count,
            m.mission_content AS mission_content,
            DATE_FORMAT(m.mission_date, '%m월 %d일') AS missionDate,
            m.mission_content AS missionContent,
            mt.theme_name AS pri_Theme_Name,
            st.theme_name AS sub_Theme_Name,
            e.emotion_name AS emotion_Name,
            c.companion_type AS companion_type,
            p.report_count,
            p.hidden_YN
        FROM
            POST p
        LEFT JOIN
            MISSION m ON p.mission_id = m.mission_id
        LEFT JOIN
            THEME mt ON m.pri_theme_id = mt.theme_id
        LEFT JOIN
            THEME st ON m.sub_theme_id = st.theme_id
        LEFT JOIN
            EMOTION e ON p.emotion_id = e.emotion_id
        LEFT JOIN
            COMPANION c ON p.companion_id = c.companion_id
        LEFT JOIN
            USER u ON p.user_id = u.user_id
    </select>
    <insert id="createPost" parameterType="com.banbanmoomani.memilog.DTO.post.CreateRequestDTO"
            useGeneratedKeys="true" keyProperty="postId">
        INSERT INTO POST
        (
            content,
            like_count,
            mission_id,
            written_datetime,
            companion_id,
            emotion_id,
            user_id
        )
        VALUES
        (
            #{content},
            0,
            (SELECT mission_id FROM MISSION WHERE mission_content = #{mission_content}),
            NOW(),
            #{companion_id},
            #{emotion_id},
            #{user_id}
        )
    </insert>
</mapper>
